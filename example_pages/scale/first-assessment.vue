<template>
  <view class="first-assessment-container">
    <view class="header">
      <text class="title">é¦–æ¬¡è®¤çŸ¥å¥åº·è¯„ä¼°</text>
      <text class="subtitle">å®Œæ•´çš„è®¤çŸ¥ä¸æƒ…ç»ªå¥åº·è¯„ä¼°</text>
    </view>
    <view class="flow-section">
      <view class="section-header">
        <text class="section-icon">ğŸ“‹</text>
        <text class="section-title">è¯„ä¼°æµç¨‹</text>
      </view>
      <view class="flow-steps">
        <view class="flow-step">
          <view class="step-number">1</view>
          <view class="step-content">
            <text class="step-title">SCD ä¸»è§‚è®¤çŸ¥ä¸‹é™é‡è¡¨</text>
            <text class="step-desc">å¿«é€Ÿè¯„ä¼°æ‚¨çš„è®¤çŸ¥çŠ¶æ€æ„Ÿå—ï¼ˆå¿…åšï¼‰</text>
          </view>
        </view>
        <view class="flow-arrow">â†“</view>
        <view class="flow-step">
          <view class="step-number">2</view>
          <view class="step-content">
            <text class="step-title">æ™ºèƒ½æµç¨‹åˆ¤å®š</text>
            <text class="step-desc">æ ¹æ®SCDç»“æœå†³å®šåç»­æµ‹è¯„å†…å®¹</text>
          </view>
        </view>
      </view>
    </view>
    <view class="assessment-section">
      <view class="section-header">
        <text class="section-icon">âœ…</text>
        <text class="section-title">åŒ…å«çš„è¯„ä¼°é¡¹ç›®</text>
      </view>
      <view class="assessment-list">
        <view class="assessment-item required">
          <text class="item-icon">ğŸ’­</text>
          <view class="item-info">
            <text class="item-title">SCD ä¸»è§‚è®¤çŸ¥ä¸‹é™</text>
            <view class="item-badge required-badge">å¿…åš</view>
          </view>
        </view>
        <view class="condition-note">
          <text class="note-text">è‹¥ SCD > 5åˆ†ï¼Œå°†ç»§ç»­ä»¥ä¸‹æµ‹è¯„ï¼š</text>
        </view>
        <view class="assessment-item conditional">
          <text class="item-icon">ğŸ§ </text>
          <view class="item-info">
            <text class="item-title">MMSE ç®€æ˜“æ™ºèƒ½çŠ¶æ€æ£€æŸ¥</text>
            <view class="item-badge">è®¤çŸ¥è¯„ä¼°</view>
          </view>
        </view>
        <view class="assessment-item conditional">
          <text class="item-icon">ğŸ¯</text>
          <view class="item-info">
            <text class="item-title">MoCA è’™ç‰¹åˆ©å°”è®¤çŸ¥è¯„ä¼°</text>
            <view class="item-badge">è®¤çŸ¥è¯„ä¼°</view>
          </view>
        </view>
        <view class="condition-note">
          <text class="note-text">æ‰€æœ‰äººéƒ½éœ€å®Œæˆä»¥ä¸‹æµ‹è¯„ï¼š</text>
        </view>
        <view class="assessment-item standard">
          <text class="item-icon">ğŸƒâ€â™‚ï¸</text>
          <view class="item-info">
            <text class="item-title">ADL æ—¥å¸¸ç”Ÿæ´»èƒ½åŠ›</text>
            <view class="item-badge">ç”Ÿæ´»è¯„ä¼°</view>
          </view>
        </view>
        <view class="assessment-item standard">
          <text class="item-icon">ğŸ˜”</text>
          <view class="item-info">
            <text class="item-title">PHQ-9 æŠ‘éƒç­›æŸ¥</text>
            <view class="item-badge">æƒ…ç»ªè¯„ä¼°</view>
          </view>
        </view>
        <view class="assessment-item standard">
          <text class="item-icon">ğŸ˜°</text>
          <view class="item-info">
            <text class="item-title">GAD-7 ç„¦è™‘ç­›æŸ¥</text>
            <view class="item-badge">æƒ…ç»ªè¯„ä¼°</view>
          </view>
        </view>
      </view>
    </view>
    <view class="tips-section">
      <view class="tips-header">
        <text class="tips-icon">ğŸ’¡</text>
        <text class="tips-title">æ¸©é¦¨æç¤º</text>
      </view>
      <view class="tips-content">
        <text class="tip-item">â€¢ è¯·åœ¨å®‰é™ã€èˆ’é€‚çš„ç¯å¢ƒä¸­å®Œæˆè¯„ä¼°</text>
        <text class="tip-item">â€¢ è¯·å‡†å¤‡å¥½çº¸ç¬”ï¼ˆéƒ¨åˆ†æµ‹è¯•éœ€è¦ï¼‰</text>
        <text class="tip-item">â€¢ è¯·æ ¹æ®çœŸå®æƒ…å†µå¦‚å®å¡«å†™</text>
        <text class="tip-item">â€¢ è¯„ä¼°è¿‡ç¨‹ä¸­å¯éšæ—¶æš‚åœ</text>
      </view>
    </view>
    <view class="action-section">
      <button class="start-btn" @click="startAssessment">
        <text class="btn-text">å¼€å§‹è¯„ä¼°</text>
        <text class="btn-icon">â†’</text>
      </button>
      <text class="time-estimate">é¢„è®¡æ€»ç”¨æ—¶ï¼š30-45åˆ†é’Ÿ</text>
    </view>
    <!-- é—®å·å¼¹çª—å¯¼èˆª -->
    <scale-questionnaire-modal
      v-if="showModal"
      :steps="steps"
      :currentStep="currentStep"
      @close="showModal = false"
      @step-complete="onStepComplete"
    />
  </view>
</template>

<script>
import ScaleQuestionnaireModal from "@/components/ScaleQuestionnaireModal.vue";

export default {
  components: { ScaleQuestionnaireModal },
  data() {
    return {
      hasCompleted: false,
      showModal: false,
      currentStep: 0,
      steps: [
        { scale_id: "scd", name: "SCD ä¸»è§‚è®¤çŸ¥ä¸‹é™é‡è¡¨" },
        { scale_id: "adl", name: "ADL æ—¥å¸¸ç”Ÿæ´»èƒ½åŠ›" },
        { scale_id: "phq9", name: "PHQ-9 æŠ‘éƒç­›æŸ¥" },
        { scale_id: "gad7", name: "GAD-7 ç„¦è™‘ç­›æŸ¥" },
        // å¯æ ¹æ® SCD ç»“æœåŠ¨æ€æ’å…¥ MMSE/MoCA
      ],
    };
  },
  onLoad() {
    this.checkIfCompleted();
  },
  methods: {
    async checkIfCompleted() {
      try {
        const res = await api.user.checkFirstAssessment();
        this.hasCompleted = !!res;
        if (this.hasCompleted) {
          uni.showModal({
            title: "æç¤º",
            content: "æ‚¨å·²å®Œæˆé¦–æ¬¡è¯„ä¼°ï¼Œæ˜¯å¦è¦é‡æ–°è¯„ä¼°ï¼Ÿ",
            success: (modalRes) => {
              if (!modalRes.confirm) {
                uni.navigateBack();
              }
            },
          });
        }
      } catch (error) {
        uni.showToast({
          title: "æ£€æŸ¥è¯„ä¼°çŠ¶æ€å¤±è´¥",
          icon: "none",
        });
      }
    },
    startAssessment() {
      this.showModal = true;
      this.currentStep = 0;
    },
    onStepComplete({ nextStep, scdScore }) {
      // æ ¹æ® SCD åˆ†æ•°åŠ¨æ€æ’å…¥è®¤çŸ¥è¯„ä¼°
      if (nextStep === 1 && scdScore > 5) {
        this.steps.splice(
          1,
          0,
          { scale_id: "mmse", name: "MMSE ç®€æ˜“æ™ºèƒ½çŠ¶æ€æ£€æŸ¥" },
          { scale_id: "moca", name: "MoCA è’™ç‰¹åˆ©å°”è®¤çŸ¥è¯„ä¼°" }
        );
      }
      this.currentStep = nextStep;
      if (nextStep >= this.steps.length) {
        this.showModal = false;
        uni.showModal({
          title: "è¯„ä¼°å®Œæˆ",
          content: "æ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼Œè¯„ä¼°å·²å…¨éƒ¨å®Œæˆï¼",
          confirmText: "è¿”å›é¦–é¡µ",
          success: () => {
            uni.reLaunch({ url: "/pages/home/home" });
          },
        });
      }
    },
  },
};
</script>

<style scoped>
@import "@/styles/mixins.scss";
/* å®¹å™¨ */
.first-assessment-container {
  min-height: 100vh;
  background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
  padding: 40rpx;
}

/* å¤´éƒ¨ */
.header {
  text-align: center;
  margin-bottom: 60rpx;
  padding: 40rpx 20rpx;
  background: #fff;
  border-radius: 30rpx;
  box-shadow: 0 4rpx 20rpx rgba(0, 0, 0, 0.08);
}

.title {
  @include title-style;
  display: block;
  margin-bottom: 20rpx;
}

.subtitle {
  display: block;
  font-size: 32rpx;
  color: #666;
}

/* åŒºå— */
.flow-section,
.assessment-section,
.tips-section {
  background: #fff;
  border-radius: 30rpx;
  padding: 40rpx;
  margin-bottom: 30rpx;
  box-shadow: 0 4rpx 20rpx rgba(0, 0, 0, 0.08);
}

.section-header {
  display: flex;
  align-items: center;
  margin-bottom: 30rpx;
}

.section-icon {
  font-size: 48rpx;
  margin-right: 20rpx;
}

.section-title {
  font-size: 40rpx;
  font-weight: bold;
  color: #1976d2;
}

/* æµç¨‹æ­¥éª¤ */
.flow-steps {
  padding: 20rpx 0;
}

.flow-step {
  display: flex;
  align-items: flex-start;
  margin-bottom: 20rpx;
}

.step-number {
  width: 60rpx;
  height: 60rpx;
  background: linear-gradient(135deg, #1890ff 0%, #096dd9 100%);
  color: #fff;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 36rpx;
  font-weight: bold;
  flex-shrink: 0;
  margin-right: 20rpx;
}

.step-content {
  flex: 1;
}

.step-title {
  display: block;
  font-size: 36rpx;
  font-weight: bold;
  color: #333;
  margin-bottom: 10rpx;
}

.step-desc {
  display: block;
  font-size: 30rpx;
  color: #666;
  line-height: 1.5;
}

.flow-arrow {
  text-align: center;
  font-size: 48rpx;
  color: #1890ff;
  margin: 20rpx 0;
}

/* è¯„ä¼°é¡¹ç›®åˆ—è¡¨ */
.assessment-list {
  padding: 20rpx 0;
}

.assessment-item {
  @include card-style;
  display: flex;
  align-items: center;
  padding: 30rpx;
  margin-bottom: 20rpx;
  border: 3rpx solid transparent;
}

.assessment-item.required {
  border-color: #1890ff;
  background: #e6f7ff;
}

.assessment-item.conditional {
  border-color: #ffa726;
  background: #fff8e1;
}

.assessment-item.standard {
  border-color: #66bb6a;
  background: #f1f8e9;
}

.item-icon {
  font-size: 48rpx;
  margin-right: 20rpx;
}

.item-info {
  flex: 1;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.item-title {
  font-size: 36rpx;
  font-weight: bold;
  color: #333;
}

.item-badge {
  padding: 8rpx 20rpx;
  background: #fff;
  border-radius: 30rpx;
  font-size: 28rpx;
  color: #666;
  border: 2rpx solid #e0e0e0;
}

.required-badge {
  background: #1890ff;
  color: #fff;
  border-color: #1890ff;
}

.condition-note {
  padding: 20rpx 30rpx;
  background: #fff9c4;
  border-radius: 15rpx;
  margin: 20rpx 0;
  border-left: 6rpx solid #ffa726;
}

.note-text {
  font-size: 32rpx;
  color: #666;
  font-weight: 500;
}

/* æ¸©é¦¨æç¤º */
.tips-header {
  display: flex;
  align-items: center;
  margin-bottom: 30rpx;
}

.tips-icon {
  font-size: 48rpx;
  margin-right: 20rpx;
}

.tips-title {
  font-size: 40rpx;
  font-weight: bold;
  color: #1976d2;
}

.tips-content {
  padding: 20rpx 30rpx;
  background: #e3f2fd;
  border-radius: 20rpx;
}

.tip-item {
  display: block;
  font-size: 32rpx;
  color: #333;
  line-height: 2;
  margin-bottom: 10rpx;
}

/* æ“ä½œåŒºåŸŸ */
.action-section {
  text-align: center;
  padding: 40rpx 0;
}

.start-btn {
  @include btn-primary;
  width: 100%;
  font-size: 42rpx;
  font-weight: bold;
  box-shadow: 0 8rpx 24rpx rgba(24, 144, 255, 0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 30rpx;
}

.btn-text {
  color: #fff;
  margin-right: 15rpx;
}

.btn-icon {
  font-size: 48rpx;
  color: #fff;
}

.time-estimate {
  font-size: 32rpx;
  color: #666;
}
</style>
