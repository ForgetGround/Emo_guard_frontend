# UniApp 路由登录拦截实现文档

## 概述
本文档总结了基于 UniApp + Vue3 + TypeScript 项目的路由登录拦截实现方案，使用黑名单模式拦截需要登录的页面。

## 使用的核心库

### 状态管理
- **pinia**: `^2.1.7` - Vue状态管理库，用于管理用户登录状态
- **pinia-plugin-persistedstate**: `^3.2.1` - Pinia状态持久化插件

### 路由系统
- **@dcloudio/uni-app**: 内置的UniApp路由系统，提供路由拦截功能

## 核心文件说明

### 1. 路由拦截器 - `src/interceptors/route.ts`
- **功能**: 实现路由跳转拦截逻辑
- **拦截方式**: 黑名单模式（大部分页面不需要登录，少部分需要）
- **拦截方法**: `navigateTo`、`reLaunch`、`redirectTo`
- **核心逻辑**: 
  - 检查目标页面是否需要登录
  - 判断用户登录状态
  - 未登录时跳转到登录页面并携带redirect参数

### 2. 用户状态管理 - `src/store/user.ts`
- **功能**: 管理用户登录状态和用户信息
- **核心状态**: 
  - `userInfo`: 用户信息对象（包含token、nickname、avatar）
  - `isLogined`: 计算属性，通过token判断登录状态
- **持久化**: 使用pinia-plugin-persistedstate实现状态持久化

### 3. 工具函数 - `src/utils/index.ts`
- **功能**: 提供页面配置解析和路由工具函数
- **核心函数**:
  - `getNeedLoginPages()`: 获取所有需要登录的页面路径
  - `currRoute()`: 获取当前页面路由信息
  - `getUrlObj()`: 解析URL获取path和query参数

### 4. 页面配置 - `src/pages.json`
- **功能**: 配置需要登录拦截的页面
- **配置方式**: 在页面配置中添加 `"needLogin": true`
- **示例**:
```json
{
  "path": "pages/demo/base/route-interceptor",
  "type": "page",
  "needLogin": true,
  "style": {
    "navigationBarTitleText": "路由拦截"
  }
}
```

### 5. 登录页面 - `src/pages/login/index.vue`
- **功能**: 提供登录功能和登录后跳转回原页面
- **核心逻辑**: 
  - 登录成功后设置用户信息
  - 根据redirect参数跳转回原页面

## 使用步骤

### 1. 安装依赖
```bash
pnpm add pinia pinia-plugin-persistedstate
```

### 2. 配置状态管理
在 `src/store/user.ts` 中配置用户状态管理：
```typescript
export const useUserStore = defineStore('user', () => {
  const userInfo = ref<IUserInfo>({ nickname: '', avatar: '', token: '' })
  const isLogined = computed(() => !!userInfo.value.token)
  
  return {
    userInfo,
    isLogined,
    setUserInfo,
    clearUserInfo
  }
}, {
  persist: true
})
```

### 3. 配置路由拦截器
在 `src/interceptors/route.ts` 中配置拦截逻辑：
```typescript
const navigateToInterceptor = {
  invoke({ url }: { url: string }) {
    const path = url.split('?')[0]
    const needLoginPages = getNeedLoginPages()
    
    if (needLoginPages.includes(path)) {
      const isLogin = isLogined()
      if (isLogin) return true
      
      const redirectRoute = `${loginRoute}?redirect=${encodeURIComponent(url)}`
      uni.navigateTo({ url: redirectRoute })
      return false
    }
    return true
  }
}
```

### 4. 注册拦截器
在应用入口注册拦截器：
```typescript
import { routeInterceptor } from '@/interceptors'

// 注册路由拦截器
routeInterceptor.install()
```

### 5. 配置需要拦截的页面
在 `src/pages.json` 中给需要登录的页面添加配置：
```json
{
  "path": "pages/member/center",
  "type": "page",
  "needLogin": true,
  "style": {
    "navigationBarTitleText": "会员中心"
  }
}
```

### 6. 实现登录功能
在登录页面实现登录逻辑：
```typescript
const login = () => {
  // 模拟登录
  userStore.setUserInfo({
    nickname: '用户名',
    avatar: '头像地址',
    token: '登录令牌'
  })
  
  // 获取redirect参数并跳转回原页面
  const { query } = currRoute()
  uni.redirectTo({ url: query.redirect })
}
```

## 高级配置

### 白名单模式
如果需要使用白名单模式（大部分页面需要登录，少部分不需要），可以修改拦截逻辑：

```typescript
const whiteList = ['/pages/index/index', '/pages/login/index']

const navigateToInterceptor = {
  invoke({ url }: { url: string }) {
    const path = url.split('?')[0]
    
    // 白名单内的页面直接放行
    if (whiteList.includes(path)) return true
    
    // 其他页面需要登录
    const isLogin = isLogined()
    if (isLogin) return true
    
    const redirectRoute = `${loginRoute}?redirect=${encodeURIComponent(url)}`
    uni.navigateTo({ url: redirectRoute })
    return false
  }
}
```

### 动态权限控制
可以在页面配置中添加更复杂的权限控制：

```json
{
  "path": "pages/admin/dashboard",
  "type": "page",
  "needLogin": true,
  "permission": "admin",
  "style": {
    "navigationBarTitleText": "管理后台"
  }
}
```

然后在拦截器中添加权限判断逻辑。

## 注意事项

1. **性能优化**: 在生产环境中，建议将 `getNeedLoginPages()` 的结果缓存起来，避免每次路由跳转都重新计算
2. **TabBar页面**: TabBar页面切换不会触发拦截器，需要单独处理
3. **分包页面**: 工具函数已支持分包页面的拦截配置
4. **H5兼容性**: 确保在H5环境下测试通过，特别是URL编码解码部分
5. **微信小程序**: 注意微信小程序的分享功能，分享出去的页面也需要考虑登录拦截

## 测试验证

项目提供了完整的测试演示页面：

- `pages/demo/route-interceptor/index` - 功能说明
- `pages/demo/route-interceptor/login-page` - 单独登录页面测试
- `pages/demo/route-interceptor/login-model` - 登录弹窗测试
- `pages/demo/route-interceptor/login-auto` - 静默登录测试
- `pages/demo/base/route-interceptor` - 基础拦截测试

可以通过这些页面验证拦截功能的正确性。
